# Complete Asset Generator for MEI Files

This script generates **all assets** needed for the rehearsal player from MEI files.

## What It Generates

For each MEI file (e.g., `we-three.mei`), the script creates:

### 1. **Timemap JSON** (`we-three.json`)
- Contains timing events for note highlighting
- Includes tempo change information
- Used to synchronize score highlighting with MIDI playback
- Format: Array of events with `tstamp`, `on`, `off`, `tempo`

### 2. **MIDI File** (`we-three.mid`)
- Standard MIDI file for audio playback
- Generated by Verovio from the MEI
- Used by Tone.js for sound synthesis
- Can also be used in other MIDI applications

### 3. **SVG Preview** (`we-three-preview.svg`)
- First page of the score rendered as SVG
- Useful for thumbnails, previews, documentation
- Rendered at 40% scale for reasonable file size
- Can be displayed directly in browsers

### 4. **Metadata JSON** (`we-three-metadata.json`)
- Title, composer, generation date
- Statistics: event count, tempo changes, file sizes
- List of all generated asset filenames
- Useful for cataloging and verification

## Installation

Install dependencies (if not already done):

```bash
npm install
```

This installs the `verovio` package (v4.5.1) with the CLI command.

## Usage

Run the complete asset generator:

```bash
npm run generate-all
```

Or directly:

```bash
node generate-all-assets.js
```

## What Happens

The script will:
1. Scan the `scores/` directory for all MEI files
2. Process each file (4 generation steps per file)
3. Display progress and statistics
4. Generate a summary report
5. Exit with status code (0 = success, 1 = errors)

## Output Example

```
üéµ Stratford Choir Christmas - Complete Asset Generator
=======================================================

This will generate for each MEI file:
  1. Timemap JSON (for highlighting)
  2. MIDI file (for playback)
  3. SVG preview (first page)
  4. Metadata JSON (title, composer, stats)

Found 53 MEI files

=======================================================

üìÑ Processing: we-three
   MEI: scores/we-three/we-three.mei
   [1/4] Generating timemap...
   ‚úì Timemap: 521 events, 3 tempo changes
   [2/4] Generating MIDI...
   ‚úì MIDI: 8.42 KB
   [3/4] Generating SVG preview...
   ‚úì SVG Preview: 156.73 KB
   [4/4] Extracting metadata...
   ‚úì Metadata: We Three Kings by John Henry Hopkins
   ‚úÖ Complete!

üìÑ Processing: holiday-favourites1
   MEI: scores/holiday-favourites/holiday-favourites1.mei
   [1/4] Generating timemap...
   ‚úì Timemap: 1193 events, 5 tempo changes
   [2/4] Generating MIDI...
   ‚úì MIDI: 24.15 KB
   [3/4] Generating SVG preview...
   ‚úì SVG Preview: 243.82 KB
   [4/4] Extracting metadata...
   ‚úì Metadata: Holiday Favourites by Various
   ‚úÖ Complete!

...

=======================================================
üìä Generating summary report...
‚úì Report saved to: scores/_generation-report.json

=======================================================
‚úÖ GENERATION COMPLETE
=======================================================
   Total Files:     53
   Successful:      53
   Failed:          0
   Time Elapsed:    12.3s
=======================================================

üìÅ Generated assets:
   ‚Ä¢ .json      - Timemap for highlighting
   ‚Ä¢ .mid       - MIDI for audio playback
   ‚Ä¢ -preview.svg - First page preview
   ‚Ä¢ -metadata.json - File information
```

## Generated Files Structure

After running, each score directory will contain:

```
scores/
  we-three/
    we-three.mei              (original MEI file)
    we-three.json             (timemap for highlighting)
    we-three.mid              (MIDI for playback)
    we-three-preview.svg      (first page preview)
    we-three-metadata.json    (file information)

  holiday-favourites/
    holiday-favourites1.mei
    holiday-favourites1.json
    holiday-favourites1.mid
    holiday-favourites1-preview.svg
    holiday-favourites1-metadata.json

  _generation-report.json     (summary of all files)
```

## Summary Report

The script generates `scores/_generation-report.json` with:
- Generation timestamp
- Success/failure counts
- Per-file statistics
- Error messages (if any)

Example report:
```json
{
  "generated": "2025-01-22T10:30:45.123Z",
  "total": 53,
  "successful": 53,
  "failed": 0,
  "files": [
    {
      "name": "we-three",
      "success": true,
      "title": "We Three Kings",
      "composer": "John Henry Hopkins",
      "timemapEvents": 521,
      "tempoChanges": 3,
      "midiSizeKB": "8.42"
    }
  ]
}
```

## How the Player Uses These Assets

### In the Browser (Current Implementation)

The player (`rehearse.html`) currently:
1. **Loads MEI** directly in the browser with Verovio
2. **Generates SVG** dynamically (allows zoom/pan)
3. **Generates MIDI** on first load (cached)
4. **Loads timemap JSON** (pre-generated by this script)

### Why Pre-generate?

1. **Verification**: Ensure all MEI files are valid
2. **Backup**: Have MIDI files ready for other uses
3. **Previews**: SVG files for documentation/thumbnails
4. **Metadata**: Catalog of all scores with statistics
5. **Faster Loading**: Optional - could serve pre-generated files

### Note on MIDI

The player generates MIDI from MEI in the browser for flexibility (zoom levels, different rendering options). The pre-generated MIDI files are:
- Useful for verification
- Can be used in other MIDI applications
- Serve as backups
- Match exactly what the player will generate

## When to Run

Run this script whenever you:
- Add new MEI files
- Update existing MEI files
- Want to verify all files are valid
- Need fresh MIDI exports
- Update the score catalog

## Troubleshooting

**"verovio CLI not found"**
- Run `npm install` to install verovio

**"No MEI files found"**
- Ensure you're in the project root
- Check that `scores/` directory exists

**Generation fails for specific file**
- Check the MEI file is valid XML
- Look at the error message in the output
- Check `_generation-report.json` for details

**Files already exist**
- The script will overwrite existing files
- This is intentional to allow regeneration
- Backup important files before running

## Performance

Approximate generation times:
- Simple score (1 page): ~0.2s
- Complex score (10 pages): ~0.5s
- 53 files: ~10-15 seconds total

The script processes files sequentially to avoid overwhelming the system.
