<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stratford Choir Christmas 2025 - Videos</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a202c;
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .video-container {
            display: grid;
            grid-template-columns: 280px 1fr 350px;
            grid-template-rows: auto 1fr;
            height: 100vh;
            gap: 0;
        }

        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-actions a {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .header-actions a:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .playlist-sidebar {
            grid-column: 1;
            grid-row: 2;
            background: #2d3748;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #4a5568;
        }

        .playlist-sidebar h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #e2e8f0;
        }

        .playlist-section {
            margin-bottom: 25px;
        }

        .playlist-section h3 {
            font-size: 0.95em;
            margin-bottom: 10px;
            color: #cbd5e0;
            padding: 8px 0;
            border-bottom: 2px solid #4a5568;
        }

        .playlist-item {
            padding: 10px 12px;
            margin-bottom: 6px;
            background: #374151;
            border: 2px solid #4a5568;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: #e2e8f0;
            font-size: 0.9em;
        }

        .playlist-item:hover {
            background: #4a5568;
            border-color: #667eea;
            transform: translateX(3px);
        }

        .playlist-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            font-weight: 600;
        }

        .player-area {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            background: #1a202c;
            padding: 0;
            position: relative;
        }

        #youtubePlayer {
            width: 100%;
            height: 100%;
            border: none;
        }

        .placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #a0aec0;
        }

        .placeholder-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .placeholder-text {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .placeholder-subtext {
            font-size: 1em;
            opacity: 0.7;
        }

        .video-list-sidebar {
            grid-column: 3;
            grid-row: 2;
            background: #2d3748;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #4a5568;
        }

        .video-list-sidebar h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #e2e8f0;
            position: sticky;
            top: 0;
            background: #2d3748;
            padding-bottom: 10px;
            z-index: 10;
        }

        .video-list-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            margin-bottom: 10px;
            background: #374151;
            border: 2px solid #4a5568;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .video-list-item:hover {
            background: #4a5568;
            border-color: #667eea;
            transform: translateX(3px);
        }

        .video-list-item.playing {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .video-thumbnail {
            width: 80px;
            height: 60px;
            background: #1a202c;
            border-radius: 4px;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }

        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-number {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .video-info {
            flex: 1;
            min-width: 0;
        }

        .video-title {
            font-size: 0.9em;
            font-weight: 500;
            color: #e2e8f0;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
        }

        .video-list-item.playing .video-title {
            color: white;
            font-weight: 600;
        }

        .video-duration {
            font-size: 0.8em;
            color: #a0aec0;
        }

        .video-list-item.playing .video-duration {
            color: rgba(255, 255, 255, 0.9);
        }

        .loading-text {
            text-align: center;
            color: #a0aec0;
            padding: 40px 20px;
            font-size: 0.95em;
        }

        @media (max-width: 1400px) {
            .video-container {
                grid-template-columns: 250px 1fr 320px;
            }
        }

        @media (max-width: 1024px) {
            .video-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 60vh auto auto;
            }

            .playlist-sidebar {
                grid-column: 1;
                grid-row: 3;
                max-height: 250px;
                border-right: none;
                border-top: 1px solid #4a5568;
            }

            .player-area {
                grid-column: 1;
                grid-row: 2;
            }

            .video-list-sidebar {
                grid-column: 1;
                grid-row: 4;
                max-height: 300px;
                border-left: none;
                border-top: 1px solid #4a5568;
            }
        }

        /* Scrollbar styling */
        .playlist-sidebar::-webkit-scrollbar,
        .video-list-sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .playlist-sidebar::-webkit-scrollbar-track,
        .video-list-sidebar::-webkit-scrollbar-track {
            background: #1a202c;
        }

        .playlist-sidebar::-webkit-scrollbar-thumb,
        .video-list-sidebar::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        .playlist-sidebar::-webkit-scrollbar-thumb:hover,
        .video-list-sidebar::-webkit-scrollbar-thumb:hover {
            background: #667eea;
        }
    </style>
</head>
<body>
    <div class="video-container">
        <div class="header">
            <h1>Stratford Choir Christmas 2025 - Videos</h1>
            <div class="header-actions">
                <a href="rehearse.html">‚Üê Back to Rehearsal</a>
            </div>
        </div>

        <div class="playlist-sidebar">
            <h2>Playlists</h2>

            <div class="playlist-section">
                <h3>Songs</h3>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8CJ4K7EXaPvUyEBE6J5dmIl" data-title="Holiday Favourites">
                    Holiday Favourites
                </div>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8AKXK6bMaaXHHixI70DvuAO" data-title="We Three Kings">
                    We Three Kings
                </div>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8A0on3BbI3Y9xE7vzhbyDbh" data-title="Winter Song">
                    Winter Song
                </div>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8AZeqgYi0oDmUT1XPSjwpQq" data-title="Our Gift For You">
                    Our Gift For You
                </div>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8DyyFBhtYc84lJvJbHPGSy9" data-title="Candlelight Carol">
                    Candlelight Carol
                </div>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8Ap3M4xBZGpJ1mFl8RuUxxT" data-title="Mary Did You Know">
                    Mary Did You Know
                </div>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8BqlzqC8IyGLU4AB2iJoZdD" data-title="It's The Most Wonderful Time of the Year">
                    It's The Most Wonderful Time of the Year
                </div>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8Ayl0ZZmEiNfNYHF2-a14Sn" data-title="The Little Drummer Boy / Peace On Earth">
                    The Little Drummer Boy / Peace On Earth
                </div>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8Cr-mYqVBis9JPFOc7GX7Yc" data-title="Mary's Holy Child">
                    Mary's Holy Child
                </div>
            </div>

            <div class="playlist-section">
                <h3>By Voice Part</h3>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8Addgz1c0qNgkVnkTVi961K" data-title="Soprano's">
                    Soprano's
                </div>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8DbpxOTxy5Z98BQjmDGV5nr" data-title="Alto's">
                    Alto's
                </div>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8CnSe71XqTv42LLjH4X26U6" data-title="Tenor's">
                    Tenor's
                </div>
                <div class="playlist-item" data-playlist="PLL88NhgWiL8CeHbp_L35TT53I57wu-iM3" data-title="Bass'">
                    Bass'
                </div>
            </div>
        </div>

        <div class="player-area" id="playerArea">
            <div class="placeholder">
                <div class="placeholder-icon">üì∫</div>
                <div class="placeholder-text">Welcome to the Video Library</div>
                <div class="placeholder-subtext">Choose a playlist from the left to start watching</div>
            </div>
            <div id="youtubePlayer"></div>
        </div>

        <div class="video-list-sidebar">
            <h2 id="videoListTitle">Playlist Videos</h2>
            <div id="videoList">
                <div class="loading-text">Select a playlist to see videos</div>
            </div>
        </div>
    </div>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        let player;
        let currentPlaylistId = null;
        let currentPlaylistTitle = '';
        let pendingPlaylistLoad = false;
        let lastLoadedPlaylistId = null;
        const playlistItems = document.querySelectorAll('.playlist-item');
        const videoList = document.getElementById('videoList');
        const videoListTitle = document.getElementById('videoListTitle');
        const playerArea = document.getElementById('playerArea');

        // YouTube IFrame API callback
        function onYouTubeIframeAPIReady() {
            console.log('YouTube IFrame API ready');
        }

        function createPlayer(playlistId) {
            // Remove placeholder
            const placeholder = playerArea.querySelector('.placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }

            if (player) {
                console.log('Loading new playlist:', playlistId);
                pendingPlaylistLoad = true;
                player.loadPlaylist({
                    list: playlistId,
                    listType: 'playlist',
                    index: 0
                });
                player.stopVideo(); // Stop current video
                // Try to load videos after a delay
                setTimeout(() => {
                    attemptLoadPlaylistVideos();
                }, 1500);
            } else {
                console.log('Creating new player with playlist:', playlistId);
                player = new YT.Player('youtubePlayer', {
                    height: '100%',
                    width: '100%',
                    playerVars: {
                        listType: 'playlist',
                        list: playlistId,
                        autoplay: 0,
                        rel: 0,
                        modestbranding: 1
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            }
        }

        function onPlayerReady(event) {
            console.log('Player ready');
            // Wait a bit for playlist to load, then fetch videos
            setTimeout(() => {
                attemptLoadPlaylistVideos();
            }, 500);
        }

        function onPlayerStateChange(event) {
            console.log('Player state changed:', event.data);

            // If we just loaded a new playlist and video is cued/playing, load the video list
            if (pendingPlaylistLoad && (event.data === YT.PlayerState.CUED || event.data === YT.PlayerState.PLAYING || event.data === YT.PlayerState.BUFFERING)) {
                console.log('New playlist loaded, fetching videos');
                pendingPlaylistLoad = false;
                setTimeout(() => {
                    attemptLoadPlaylistVideos();
                }, 500);
            }

            // Update playing state in video list
            updatePlayingVideo();
        }

        function attemptLoadPlaylistVideos(retries = 0) {
            if (!player || !currentPlaylistId) {
                console.log('Cannot load videos - no player or playlist ID');
                return;
            }

            try {
                const playlist = player.getPlaylist();

                if (!playlist || playlist.length === 0) {
                    if (retries < 5) {
                        console.log('Playlist not ready, retry', retries + 1);
                        setTimeout(() => attemptLoadPlaylistVideos(retries + 1), 500);
                    } else {
                        console.log('Failed to load playlist after retries');
                        videoList.innerHTML = '<div class="loading-text">Unable to load videos. Try clicking a video in the player.</div>';
                    }
                    return;
                }

                // Only reload if this is a different playlist
                if (lastLoadedPlaylistId !== currentPlaylistId) {
                    console.log('Loading videos for new playlist');
                    lastLoadedPlaylistId = currentPlaylistId;
                    loadPlaylistVideos();
                } else {
                    console.log('Playlist already loaded');
                }
            } catch (error) {
                if (retries < 5) {
                    console.log('Error checking playlist, retry', retries + 1, error);
                    setTimeout(() => attemptLoadPlaylistVideos(retries + 1), 500);
                } else {
                    console.error('Failed to load playlist after retries:', error);
                }
            }
        }

        function updatePlayingVideo() {
            if (!player || !player.getPlaylistIndex) return;

            try {
                const currentIndex = player.getPlaylistIndex();
                const videoItems = document.querySelectorAll('.video-list-item');

                videoItems.forEach((item, index) => {
                    if (index === currentIndex) {
                        item.classList.add('playing');
                        // Scroll into view
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        item.classList.remove('playing');
                    }
                });
            } catch (error) {
                console.error('Error updating playing video:', error);
            }
        }

        async function fetchVideoTitle(videoId) {
            try {
                const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
                if (response.ok) {
                    const data = await response.json();
                    return data.title || `Video`;
                }
            } catch (error) {
                console.error('Error fetching video title:', error);
            }
            return `Video`;
        }

        async function loadPlaylistVideos() {
            if (!currentPlaylistId || !player) return;

            videoList.innerHTML = '<div class="loading-text">Loading playlist videos...</div>';
            videoListTitle.textContent = currentPlaylistTitle;

            try {
                // Get playlist from player
                const playlist = player.getPlaylist();

                if (!playlist || playlist.length === 0) {
                    videoList.innerHTML = '<div class="loading-text">No videos in playlist. Try playing a video first!</div>';
                    return;
                }

                console.log('Playlist loaded:', playlist.length, 'videos');
                videoList.innerHTML = '';

                // Create video items from playlist
                for (let index = 0; index < playlist.length; index++) {
                    const videoId = playlist[index];
                    const thumbnail = `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`;

                    const videoItem = document.createElement('div');
                    videoItem.className = 'video-list-item';
                    videoItem.dataset.index = index;
                    videoItem.dataset.videoId = videoId;

                    videoItem.innerHTML = `
                        <div class="video-thumbnail">
                            <img src="${thumbnail}" alt="Video ${index + 1}" loading="lazy">
                            <div class="video-number">${index + 1}</div>
                        </div>
                        <div class="video-info">
                            <div class="video-title">Loading...</div>
                        </div>
                    `;

                    videoItem.addEventListener('click', () => {
                        if (player && player.playVideoAt) {
                            player.playVideoAt(index);
                        }
                    });

                    videoList.appendChild(videoItem);

                    // Fetch title asynchronously
                    fetchVideoTitle(videoId).then(title => {
                        const titleEl = videoItem.querySelector('.video-title');
                        if (titleEl) {
                            titleEl.textContent = title;
                        }
                    });
                }

                // Update playing state
                setTimeout(() => {
                    updatePlayingVideo();
                }, 100);

            } catch (error) {
                console.error('Error loading playlist videos:', error);
                videoList.innerHTML = '<div class="loading-text">Playlist videos will appear here. Click play to start watching!</div>';
            }
        }

        function loadPlaylist(playlistId, title, element) {
            // Remove active class from all items
            playlistItems.forEach(item => item.classList.remove('active'));

            // Add active class to clicked item
            element.classList.add('active');

            // Update current playlist
            currentPlaylistId = playlistId;
            currentPlaylistTitle = title;

            // Show loading message in video list
            videoList.innerHTML = '<div class="loading-text">Loading playlist...</div>';
            videoListTitle.textContent = title;

            // Create or update player (will trigger onPlayerReady which loads videos)
            createPlayer(playlistId);
        }

        // Add click listeners to all playlist items
        playlistItems.forEach(item => {
            item.addEventListener('click', function() {
                const playlistId = this.dataset.playlist;
                const title = this.dataset.title;
                loadPlaylist(playlistId, title, this);
            });
        });

        // Update playing video periodically
        setInterval(() => {
            if (player && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) {
                updatePlayingVideo();
            }
        }, 1000);
    </script>
</body>
</html>
