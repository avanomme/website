# Timemap Generator for MEI Files

This script automatically generates timemap JSON files for all MEI files in the `scores/` directory.

## What It Does

The script:
1. Scans the `scores/` directory for MEI files (e.g., `scores/we-three/we-three.mei`)
2. Uses the Verovio CLI command to generate timemaps
3. Each timemap contains note on/off events and tempo changes
4. Saves the timemap as a JSON file (e.g., `scores/we-three/we-three.json`)

These timemaps are used by the rehearsal tool to:
- Highlight notes accurately during playback
- Handle tempo changes in the music correctly
- Synchronize the score display with MIDI playback perfectly

## Installation

First, install the required dependencies:

```bash
npm install
```

This will install the `verovio` package (version 4.5.1) which includes the CLI command.

## Usage

Run the script:

```bash
npm run generate-timemaps
```

Or directly:

```bash
node generate-timemaps.js
```

## Output

The script will:
- Show progress for each MEI file being processed
- Display the number of events generated for each file
- Save JSON files alongside the MEI files
- Show a summary of successful and failed generations

Example output:
```
ðŸŽµ Stratford Choir Christmas - Timemap Generator
================================================

Found 53 MEI files:

  â€¢ candlelight-carol
  â€¢ holiday-favourites1
  â€¢ we-three
  ...

ðŸ“„ Processing: holiday-favourites1
   MEI: scores/holiday-favourites/holiday-favourites1.mei
   JSON: scores/holiday-favourites/holiday-favourites1.json
   âœ“ Generated timemap with 1193 events
   âœ“ Already has on/off events - no processing needed
   âœ“ Saved to holiday-favourites1.json

...

================================================
âœ… Summary:
   Total: 53 files
   Success: 53
   Failed: 0
================================================
```

## Timemap Format

Each JSON file contains an array of events generated by Verovio with:
- `tstamp`: Timestamp in milliseconds
- `qstamp`: Quarter note timestamp (for MIDI synchronization)
- `on`: Array of note IDs that start at this time
- `off`: Array of note IDs that end at this time
- `tempo`: BPM (only on tempo change events)

Example from `holiday-favourites1.json`:
```json
[
  {
    "on": ["mscore-YbkTXAI2YoI_OK8sJQ-exS"],
    "qstamp": 0,
    "tempo": 104,
    "tstamp": 0
  },
  {
    "off": ["mscore-YbkTXAI2YoI_OK8sJQ-exS"],
    "on": ["mscore-rJpta2GjU8O_Zt8KPsKKA0"],
    "qstamp": 0.3333333333333333,
    "tstamp": 192
  },
  {
    "on": ["mscore-xyz123"],
    "qstamp": 125.5,
    "tempo": 80,
    "tstamp": 72692
  }
]
```

The timemap for `holiday-favourites1.json` contains **1193 events** with **5 tempo changes** throughout the piece.

## When to Run

Run this script whenever you:
- Add new MEI files to the `scores/` directory
- Update existing MEI files
- Want to regenerate all timemaps

## Troubleshooting

If the script fails:

1. **"verovio module not found"**: Run `npm install` to install dependencies

2. **"Scores directory not found"**: Make sure you're running the script from the project root directory

3. **"Failed to load MEI data"**: Check that the MEI file is valid and not corrupted

4. **"No timemap events found"**: The MEI file may not contain timing information

## Files

- `generate-timemaps.js`: Main script
- `package.json`: Contains the `verovio` dependency
- `scores/`: Directory containing MEI files and generated JSON timemaps
